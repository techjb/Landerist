<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ORELS Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.classless.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/ajv/dist/ajv.bundle.js"></script>
</head>
<body>
    <header>
        <hgroup>
            <h1>ORELS Viewer</h1>
            <h2>
                View real state listings in
                <a href="https://github.com/techjb/Open-Real-Estate-Listings-Schema">ORELS</a>
                format.
            </h2>
        </hgroup>
    </header>
    <main>
        <section>
            <form>
                <label for="select">Schema</label>
                <select id="select" name="select" required>
                    <option value="" selected>ES/1.0</option>
                </select>
                <label for="json-file">
                    Select/dragg Json in ORELS format
                    <input type="file" id="json-file" accept=".json" />
                </label>
            </form>
            <div id="validation-result"></div>
            <pre id="json-preview"></pre>
        </section>
    </main>
    <footer>
        <script type="text/javascript">
            var schema;
            var validationResult = document.getElementById("validation-result");
            var jsonPreview = document.getElementById("json-preview");
            var jsonFile = document.getElementById("json-file");

            PreloadSchema();

            function PreloadSchema() {
                var getJSON = function (url, callback) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', url, true);
                    xhr.responseType = 'json';
                    xhr.onload = function () {
                        var status = xhr.status;
                        if (status === 200) {
                            callback(null, xhr.response);
                        } else {
                            callback(status, xhr.response);
                        }
                    };
                    xhr.send();
                };

                let url = 'https://raw.githubusercontent.com/techjb/Open-Real-Estate-Listings-Schema/master/ES/1.0.json';

                getJSON(url, function (err, data) {
                    if (err !== null) {
                        alert('Something went wrong: ' + err);
                    } else {
                        schema = data;
                    }
                });
            }

            function Reset() {
                validationResult.textContent = "";
                jsonPreview.textContent = "";
            }

            jsonFile.addEventListener("change", (e) => {
                Reset();
                const file = e.target.files[0];
                ViewFile(file);
            });


            function ViewFile(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    OnLoadFile(event);
                };
                reader.readAsText(file);
            };

            function OnLoadFile(event) {
                try {
                    const json = JSON.parse(event.target.result);
                    const ajv = new Ajv();                    
                    const isValid = ajv.validate(schema, json);

                    if (isValid) {
                        validationResult.textContent = "JSON is valid.";
                        ShowJson(json);
                    } else {
                        console.log(ajv.errors)
                        validationResult.textContent = "JSON is not valid. Reason: " + ajv.errors;
                    }

                } catch (error) {                    
                    validationResult.textContent = "Error reading file: " + error.message;
                }
            }

            function ShowJson(json) {
                for (var i = 0; i < json.listings.length; i++) {
                    var listing = json.listings[i];
                    ShowListing(listing);
                }
            }

            function ShowListing(listing) {
                console.log(listing);
                try {

                }
                catch {

                }
            }
        </script>
    </footer>
</body>
</html>
